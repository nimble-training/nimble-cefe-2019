---
title: "Multi-State Capture-Recapture Model: `dHMM` distribution"
output: html_document
---

---

\   

```{r, echo = FALSE, message = FALSE}
library(nimble, quiet = TRUE)
load('~/github/nimble/nimble-cefe-2019/docs/data/orchid_data.Rdata')
```




### Rewrite model using `dHMM` distribution

Next, we'll rewrite the orchid model using the `dHMM` distribution from the
`nimbleEcology` package.

```{r eval = FALSE}
orchidHMMcode <- nimbleCode({
    ## Survival
    s ~ dunif(0, 1)
    ## Transitions: gamma priors 
    for (i in 1:3){
        a[i] ~ dgamma(1, 1) 
        psiD[i] <- a[i]/sum(a[1:3]) 
        b[i] ~ dgamma(1, 1) 
        psiV[i] <- b[i]/sum(b[1:3]) 
        c[i] ~ dgamma(1, 1) 
        psiF[i] <- c[i]/sum(c[1:3]) 
    }
    ## Define state-transition matrix
    ps[1,1] <- s * psiV[1]
    ps[2,1] <- s * psiV[2]
    ps[3,1] <- s * psiV[3]
    ps[4,1] <- 1-s
    ps[1,2] <- s * psiF[1]
    ps[2,2] <- s * psiF[2]
    ps[3,2] <- s * psiF[3]
    ps[4,2] <- 1-s
    ps[1,3] <- s * psiD[1]
    ps[2,3] <- s * psiD[2]
    ps[3,3] <- s * psiD[3]
    ps[4,3] <- 1-s
    ps[1,4] <- 0
    ps[2,4] <- 0
    ps[3,4] <- 0
    ps[4,4] <- 1
    ## Likelihood
    for (i in 1:N) {
        y[i, first[i]:T] ~ dHMM(init = init[1:4],
                                probObs = po[1:4, 1:3],
                                probTrans = ps[1:4, 1:4],
                                len = length[i])
    }
})
```

\   

### Implementation of the `dHMM` distribution

Once again, let's take a quick look at the underlying implementation
of the `dHMM` distribution.

\   

```{r eval = FALSE}
dHMM <- nimbleFunction(
    run = function(x = double(1), init = double(1), probObs = double(2),
        probTrans = double(2), len = double(0, default = 0),
        log = integer(0, default = 0)) {
        pi <- init    # state probabilities at time t=1
        logL <- 0
        for (t in 1:len) {
            Zpi <- probObs[, x[t]] * pi
            sumZpi <- sum(Zpi)            # total p(observed as class x[t])
            logL <- logL + log(sumZpi)
            if (t != len) pi <- (probTrans[,] %*% asCol(Zpi) / sumZpi)[ ,1]
        }
        returnType(double())
        if (log) return(logL)
        return(exp(logL))
    }
)
```

\   


### Data, constants, and inital values


Define the necesary constants and initial values.  These are similar
to the latent state model, with the following changes:

- We provide the `length` variable as a constant.
- We provide a new constant, `init[1:4]`, which gives the initial
probabilities for each of the 4 possible latent states.
- Instead of defining the `po` matrix as deterministic nodes in
the model definition, we provide this constant `po` matrix through the
constants list.
- We no longer provide initial values for `z`. 


```{r eval = FALSE}
N <- dim(y)[1]
T = dim(y)[2]

length <- T - first + 1
init <- c(1/3, 1/3, 1/3, 0)
po <- array(c(1,0,0,0,0,1,0,0,0,0,1,1), c(4,3))

orchidHMMconsts <- list(N = N, T = T, first = first,
                        length = length, init = init, po = po)

orchidHMMdata <- list(y = y)

orchidHMMinits <- list(a = rep(1, 3),
                       b = rep(1, 3),
                       c = rep(1, 3),
                       s = 0.5)
```

\   

### Fit the `dHMM` model

Now, we'll fit the orchid model using `compareMCMCs`:

```{r eval = FALSE}
library(nimbleEcology)

library(compareMCMCs)

outHMM <- compareMCMCs(
    modelInfo = list(code = orchidHMMcode, constants = orchidHMMconsts,
                     data = orchidHMMdata, inits = orchidHMMinits),
    MCMCs = 'nimble',
    MCMCcontrol = list(niter = 5000, nburnin = 1000))

## extract the posterior samples
samplesHMM <- outHMM$nimble$samples
```


```{r echo = FALSE, eval = FALSE}
save('outHMM', 'samplesHMM', file = '~/github/nimble/nimble-cefe-2019/docs/data/orchidHMM_samples.Rdata')
```

```{r echo = FALSE}
load('~/github/nimble/nimble-cefe-2019/docs/data/orchidHMM_samples.Rdata')
```

\   

### Results


```{r fig.height = 3, fig.width = 8}
round(samplesSummary(samplesHMM), 2)

library(basicMCMCplots)
basicMCMCplots::samplesPlot(samplesHMM)
```




\  

\  

\  

\  

\  

\  

\  

\  

\  

\  

\  

\  

\  

\  




